# 1	å‰è¨€

> `immerJs`æ˜¯ã€Šä¸å¯å˜æ•°æ®ç±»å‹ã€‹çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œå¦‚æœè¿˜ä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å»çœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„æ–‡ç«  [ImmerJsä½¿ç”¨è¯¦è§£](https://juejin.cn/post/7023944098578956324)

è·ç¦»ä¸Šä¸€ç¯‡ä½¿ç”¨æ–‡ç« çš„å‘å¸ƒå·²ç»è¿‡å»äº†ä¸€ä¸ªæœˆçš„æ—¶é—´ï¼Œæœ¬ç¯‡æ–‡ç« æœ¬æ¥æƒ³åœ¨ä½¿ç”¨æ•™ç¨‹çš„é‚£ä¸€å‘¨ä¸€èµ·å‘å¸ƒï¼Œä½†æ˜¯ç”±äºæ‡’çš„ç¼˜æ•…ï¼Œä¸€ç›´æ‹–åˆ°äº†ç°åœ¨



# 2	Proxy

åœ¨å­¦ä¹ `immerJs`çš„åŸç†ä¹‹å‰ï¼Œè¿˜éœ€è¦äº†è§£ä¸€ä¸‹ `proxy`ã€‚å¦‚æœå·²ç»å­¦ä¼š `Proxy`çš„å°ä¼™ä¼´ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ğŸ‘‰ [ç¬¬ä¸‰ç« ](# 3	immerJsåŸç†è§£æ)

å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ï¼Œ`Proxy`æ˜¯ç”¨æ¥ç›‘å¬æ•°æ®å˜åŒ–çš„ï¼Œå½“å¯¹è±¡ä¸­çš„æŸä¸ªå€¼å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šè¢« `Proxy` æ‹¦æˆªï¼Œ`Vue3`ä¸­å°±æ˜¯å€ŸåŠ©è¿™ä¸ªç‰¹æ€§çŸ¥é“å“ªäº›æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå¯¹åº”çš„å“ªäº›`DOM`éœ€è¦å‘ç”Ÿå˜åŒ–ï¼Œè€Œ`React`å°±éœ€è¦éå†æ•´æ£µè™šæ‹Ÿ`dom`æ ‘ï¼Œä»è€Œæ‰¾å‡ºå˜åŒ–çš„é¡¹

`immerJs`ä¹Ÿæ˜¯ä½¿ç”¨`Proxy`å®ç°çš„ï¼Œé€šè¿‡ç›‘å¬å“ªäº›å€¼å‘ç”Ÿå˜åŒ–ï¼Œé’ˆå¯¹æ€§çš„ä¿®æ”¹å˜åŒ–çš„å€¼çš„åœ°å€æŒ‡å‘ï¼Œæ²¡æœ‰ä¿®æ”¹çš„å€¼ä¿ç•™æ—§çš„å¼•ç”¨ï¼Œä»è€ŒèŠ‚çœå†…å­˜ç©ºé—´ï¼Œä¸‹å›¾æ˜¯å€Ÿç”¨ç½‘ç»œä¸Šå¯¹`immutableJs`ä»‹ç»çš„å›¾ç‰‡è¿›è¡ŒåŸºæœ¬åŸç†æ¼”ç¤º

![img](./image/webp.webp)



## 2.1	Proxyçš„â€œç¼ºé™·â€

å…ˆçœ‹çœ‹`Proxy`æ€ä¹ˆç”¨çš„ï¼Œ`Proxy`ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ä¼ å…¥ `get`ï¼Œ`set`ï¼Œ`deleteProperty`ç­‰æ‹¦æˆªäº‹ä»¶ï¼Œå½“å¯¹å¯¹è±¡è¿›è¡Œå¢ï¼Œåˆ ï¼Œæ”¹çš„æ—¶å€™ï¼Œéƒ½ä¼šè§¦å‘å¯¹åº”çš„æ–¹æ³•

```ts
const obj = {
  a: 'a',
  b: 'b',
  c: 'c'
}

const proxyObj = new Proxy(obj, {
  get(state, key) {
    console.log(`è·å–äº†${key}`)
    return Reflect.get(state, key)
  },
  set(state, key, value) {
    console.log(`${key}å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº†${value}`)
    return Reflect.set(state, key, value)
  },
  deleteProperty(state, key) {
    console.log(`${key}è¢«åˆ é™¤äº†`)
    return Reflect.deleteProperty(state, key)
  }
})

proxyObj.a = 'a-1'
proxyObj.b
delete proxyObj.b
```

æ§åˆ¶å°çš„æ‰“å°å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡è·å–å’Œä¿®æ”¹å€¼çš„ä¹‹åï¼Œéƒ½ä¼šè§¦å‘ `Proxy` çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­å¯¹åº”çš„æ‹¦æˆªå‡½æ•°

![image-20211208170404535](./image/image-20211208170404535.png)

ä¼¼ä¹ä¸€åˆ‡éƒ½å¾ˆå®Œç¾ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹ï¼Œ`Proxy`æ— æ³•åšåˆ°ï¼Œå°±æ˜¯å¯¹å…¶æ·±å±‚æ¬¡å¯¹è±¡çš„ç›‘å¬ï¼Œå¦‚ä¸‹

```ts
const obj = {
  a: {
    b: 1
  }
}

const proxyObj = new Proxy(obj, {
  get(state, key) {
    console.log(`è·å–äº†${key}`)
    return Reflect.get(state, key)
  },
  set(state, key, value) {
    console.log(`${key}å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº†${value}`)
    return Reflect.set(state, key, value)
  },
  deleteProperty(state, key) {
    console.log(`${key}è¢«åˆ é™¤äº†`)
    return Reflect.deleteProperty(state, key)
  }
})

proxyObj.a.b = 2
```

æ§åˆ¶å°æ‰“å°å¦‚ä¸‹

![image-20211208170909792](./image/image-20211208170909792.png)

ä¹‹æ‰€ä»¥ä¼šè¿™æ ·ï¼Œæ˜¯å› ä¸º `proxyObj.a.b = 2` è¿™å¥ä»£ç ï¼Œå…¶å®å¯ä»¥æŠŠå®ƒçœ‹æˆä¸‰æ­¥é€»è¾‘

![image-20211208171546026](./image/image-20211208171546026.png)

ç¬¬ä¸€æ­¥ï¼Œå–å‡º`a`çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šè§¦å‘`Proxy`çš„`get`ä»£ç†ï¼Œç„¶åè¿™ä¸ªæ—¶å€™ï¼Œä¼šæŠŠ `{ b: 1 }` è¿™ä¸ªå¯¹è±¡è¿”å›

![image-20211208171723613](./image/image-20211208171723613.png)

ç¬¬äºŒæ­¥ï¼Œä» `{ b: 1 }` è¿™ä¸ªå¯¹è±¡ä¸­å– `b`ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œ `{ b: 1 }` å¯æ²¡æœ‰è¢«`Proxy`ä»£ç†è¿‡ï¼Œè‡ªç„¶ä¸ä¼šè¢«æ‹¦æˆªï¼Œæ§åˆ¶å°ä¹Ÿä¸ä¼šè¾“å‡ºä»€ä¹ˆå†…å®¹

![image-20211208171943807](./image/image-20211208171943807.png)

æœ€åå†æŠŠ`2`èµ‹å€¼ç»™`b`ï¼Œå› ä¸ºç°åœ¨å·²ç»å’Œ`proxyObj`æ²¡ä»€ä¹ˆå…³ç³»äº†ï¼Œæ‰€ä»¥`proxyObj`çš„ä»£ç†æ–¹æ³•ä¹Ÿä¸ä¼šè¢«è§¦å‘

![image-20211208172333361](./image/image-20211208172333361.png)

è¿™å…¶å®å¹¶ä¸æ˜¯ `Proxy`çš„ç¼ºé™·ï¼Œå› ä¸ºè¿™æ˜¯åˆç†çš„ï¼Œå¦‚æœå­å¯¹è±¡çš„ä¿®æ”¹ä¹Ÿèƒ½è§¦å‘çˆ¶å¯¹è±¡çš„æ‹¦æˆªï¼Œé‚£è¿™å°±ä¹±å¥—äº†



## 2.2	Proxy.revocable

æ¥ä¸‹æ¥ï¼Œæ¥å­¦ä¹ ä¸€ä¸‹ `Proxy` ä¸Šçš„ä¸€ä¸ªé™æ€æ–¹æ³• `revocable`ï¼Œè¿™ä¸ªæ–¹æ³•å’Œ`Proxy`çš„ç”¨é€”ä¸€è‡´ï¼Œåªä¸è¿‡ï¼Œæ¯”`Proxy`å¤šäº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯å¯ä»¥å–æ¶ˆä»£ç†ï¼Œä½¿ç”¨å¦‚ä¸‹

```ts
const obj = {
  a: 'a',
  b: 'b',
  c: 'c'
}

const { proxy, revoke } = Proxy.revocable(obj, {
  get(state, key) {
    console.log(`è·å–äº†${key}`)
    return Reflect.get(state, key)
  },
  set(state, key, value) {
    console.log(`${key}å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº†${value}`)
    return Reflect.set(state, key, value)
  },
  deleteProperty(state, key) {
    console.log(`${key}è¢«åˆ é™¤äº†`)
    return Reflect.deleteProperty(state, key)
  }
})

proxy.a = 'a-1'
proxy.b

revoke()

delete proxy.b
```

å½“æ‰§è¡Œ`revoke`åï¼Œ`proxy`å¯¹è±¡å°±ä¼šè¢«é”€æ¯

![image-20211208173430444](./image/image-20211208173430444.png)

å¥½ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œ`immerJs`åŸç†è§£æçš„å‰ç½®çŸ¥è¯†å°±å·²ç»è®²è§£å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±è¦è¿›å…¥é‡å¤´æˆ



# 3	immerJsåŸç†è§£æ

æˆ‘ä»¬å¤ä¹ ä¸€ä¸‹`immerJs`æ˜¯å¦‚ä½•ä½¿ç”¨çš„

```ts
import produce from 'immer'

const baseState = {
  a1: {
    b1: {
      c1: 'c1',
    },
    b2: {
      c2: 'c2'
    }
  },
  a2: 'a2'
}

const nextState = produce(baseState, (draft) => {

  draft.a2 = 'a2-edit'

  draft.a1.b.c1 = 'c1-edit'

})

// æ ¹èŠ‚ç‚¹å¼•ç”¨å˜äº†
console.log(baseState === nextState)			    // false
// a1å’Œå­èŠ‚ç‚¹å¼•ç”¨å˜äº†ï¼Œæ‰€ä»¥a1ä¹Ÿå˜äº†
console.log(nextState.a1 === baseState.a1)	      	// false
// b2å’Œå­èŠ‚ç‚¹æ²¡ä¿®æ”¹è¿‡ï¼Œæ‰€ä»¥b2è¿˜æ˜¯åŸæ¥çš„å¼•ç”¨
console.log(nextState.a1.b2 === baseState.a1.b2)	// true
```

`immerJs`çš„ä½¿ç”¨å¯ä»¥ç®€åŒ–ä¸ºä¸‰éƒ¨åˆ†ï¼Œå³

-  **å¯¹åŸºç¡€æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼š**`produce`

- **å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹é€»è¾‘ï¼š**`recipe`

- **ä¿®æ”¹åçš„æ•°æ®ï¼š**`nextState`

å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„éƒ¨åˆ†ï¼Œåœ¨`immerJs`ä¸­çš„å½¢å‚åä¸º `recipe`ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç”¨ `recipe`æ¥å½¢å®¹å®ƒ

![image-20211208175809754](./image/image-20211208175809754.png)

## 3.1	å¯¹è±¡

æˆ‘ä»¬å°±ä»¥ä¸Šé¢ä¾‹å­ä¸­é‚£ä¸ªå¯¹è±¡ä¸ºä¾‹å­

```ts
const baseState = {
  a1: {
    b1: {
      c1: 'c1',
    },
    b2: {
      c2: 'c2'
    }
  },
  a2: 'a2'
}
```

æè¿°çš„æˆå›¾å½¢ç»“æ„å¦‚ä¸‹

![image-20211209154445498](./image/image-20211209154445498.png)

æ¥ç€å¼€å§‹åŸç†è®²è§£

### 3.1.1	å®šä¹‰æ•è·å™¨

`immerJs`åœ¨å…¨å±€å®šä¹‰äº†ä¸€ä¸ª `objectTraps`ï¼Œç”¨æ¥ä¿å­˜ åˆ°æ—¶å€™è¦ä¼ å…¥ `Proxy` çš„ç¬¬äºŒä¸ªå‚æ•°

```ts
const objectTraps = {
  get(state, prop) {
  },
  set(state, prop, value) {
  },
  has(state, prop) {
  },
  ownKeys(state) {
  },
  deleteProperty(state, prop) {
  }
}
```



### 3.1.2	å¯¹ä¼ å…¥çš„å¯¹è±¡è¿›è¡Œä»£ç†

æ¥ç€ï¼Œå¯¹ä¼ å…¥çš„`baseState`è¿›è¡Œä»£ç†ï¼Œä½†æ˜¯ä¸æ˜¯ç›´æ¥æŠŠ `baseState` ä¼ å…¥ `Proxy.revocable`ç›´æ¥è¿›è¡Œä»£ç†ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ª**ä¸­é—´å¯¹è±¡**ï¼Œè¿™ä¸ª**ä¸­é—´å¯¹è±¡**ç”±6ä¸ªæœ€åŸºæœ¬çš„å…ƒç´ ç»„æˆ

- **parent_:**  å­˜æ”¾`baseState`çš„çˆ¶èŠ‚ç‚¹ï¼Œç”±äºå½“å‰æ˜¯æ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™ä¸ªå€¼ç°åœ¨ä¸º`null`

-  **base_:**  å­˜æ”¾`baseState`
-  **copy_:**  æš‚æ—¶å®šä¹‰ä¸º`null`ï¼Œåé¢è¦ç”¨
-  **draft_:**   æŠŠè¿™ä¸ªä¸­é—´ç†å¯¹è±¡ä¼ å…¥  `Proxy.revocable` ï¼Œä¿å­˜è¿”å›çš„ `proxy`
-  **revoke_:  ** æŠŠè¿™ä¸ªä¸­é—´ç†å¯¹è±¡ä¼ å…¥  `Proxy.revocable` ï¼Œä¿å­˜è¿”å›çš„ `revoke`
- **modified_:** æš‚æ—¶å®šä¹‰ä¸º`false`ï¼Œåé¢è¦ç”¨

ç„¶åï¼ŒæŠŠè¿™ä¸ª**ä¸­é—´å¯¹è±¡**ä¼ å…¥  `Proxy.revocable` ä¸­ï¼Œè®°å¾—ç¬¬äºŒä¸ªå‚æ•°è¦ä¼ é€’åˆšæ‰å®šä¹‰çš„ `objectTraps`ï¼ŒæŠŠè¿”å›çš„ `proxy`ï¼Œ`revoke`åˆ†åˆ«å­˜å…¥åˆ°ä¸­é—´å¯¹è±¡ä¸­ï¼Œå›¾å¦‚ä¸‹

![image-20211209154505925](./image/image-20211209154505925.png)

### 3.1.3	æ‰§è¡Œrecipe

æ¥ç€ï¼Œç›´æ¥æ‰§è¡Œ`produce`ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå³ `recipe`ï¼ŒæŠŠç¬¬äºŒæ­¥ç”Ÿæˆçš„**ä¸­é—´å¯¹è±¡**ä¼ é€’ç»™`recipe`ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ`recipe`ä¸­æ“ä½œçš„`draft`å…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬äºŒæ­¥ç”Ÿæˆçš„é‚£ä¸ªä¸­é—´å¯¹è±¡

![image-20211209154521294](./image/image-20211209154521294.png)

æ¥ç€ï¼Œå°±ä¼šæ‰§è¡Œ`recipe`ä¸­çš„ç¬¬ä¸€è¡Œè¯­å¥ï¼Œå³ 

```ts
draft.a1.b1.c1 = 'c1-edit'
```

é‚£ä¹ˆï¼Œè¿™å¥è¯å…¶å®å¯ä»¥æ‹†æˆ `3` æ­¥é€»è¾‘ï¼Œå³ç¬¬ä¸€æ­¥ï¼Œä» `draft`  ä¸­å–å‡º `a1`ï¼Œè¿™æ—¶ï¼Œä¾¿ä¼šè§¦å‘åˆšæ‰æˆ‘ä»¬å®šä¹‰çš„ `traps`ã€‚

ç°åœ¨æ˜¯è·å–`a1`çš„å€¼ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘`objectTraps.get`è¿™ä¸ªæ–¹æ³•ã€‚åœ¨è¿™ä¸ª`trap` ä¸­ï¼Œä¸€å®šä¼šæ¥æ”¶åˆ°ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯åˆšæ‰æˆ‘ä»¬ä¸º `baseState` åˆ›å»ºçš„ä¸­é—´å¯¹è±¡ ï¼Œç¬¬äºŒä¸ªæ˜¯è¦è·å–çš„`key`å³`a1`ï¼Œè¿™ä¸ª`trap`çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹

![image-20211209165659599](./image/image-20211209165659599.png)

é‚£ä¹ˆ `draft.a1` è¿™ä¸€è¯­å¥çš„æ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹

![image-20211209165721391](./image/image-20211209165721391.png)

ä¹‹æ‰€ä»¥è¦ä¸º`a1`çš„å€¼åˆ›å»ºä¸­é—´å¯¹è±¡å¹¶è¿”å›ï¼Œå› ä¸º`Proxy`åªèƒ½ç›‘å¬ç¬¬ä¸€å±‚çš„å˜åŒ–ï¼Œå­å…ƒç´ çš„å˜åŒ–`Proxy`çš„ç›‘å¬ä¸äº†ï¼Œå¦‚æœç›´æ¥è¿”å›`a1`çš„å€¼ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œå°±æ–­æ‰äº†ï¼Œå­å…ƒç´ çš„ä¿®æ”¹`immerJs`ç›‘å¬ä¸åˆ°

é‚£ä¹ˆç¬¬äºŒæ­¥ï¼Œå°±æ˜¯ ä» `a1` ä¸­å–å‡º `b1`ï¼Œå› ä¸ºåˆšæ‰è¿”å›äº†`a1`çš„ä¸­é—´å¯¹è±¡çš„ä»£ç†ï¼Œæ‰€ä»¥ï¼Œä¹Ÿä¼šèµ°ä¸Šé¢çš„ `get trap`  æµç¨‹ï¼Œè‡ªç„¶ï¼Œä¹Ÿä¼šä¸º `b1` åˆ›å»ºä¸€ä¸ªä¸­é—´å¯¹è±¡å¹¶ä»£ç†ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œåœ¨å†…å­˜ä¸­ï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªé“¾è¡¨

![image-20211209154614589](./image/image-20211209154614589.png)

æ‰§è¡Œæœ€åä¸€æ­¥ï¼Œå°±æ˜¯ `draft.a1.b1.c1 = 'c1-edit'` ä¸­çš„`b1.c1 = 'c1-edit'`è¿™ä¸€é˜¶æ®µï¼Œå› ä¸ºåˆšæ‰ä¸º`b1`åˆ›å»ºäº†ä¸­é—´å¯¹è±¡å¹¶ä¸ºä¸­é—´å¯¹è±¡åˆ›å»ºäº†ä»£ç†ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ä¼šè¢« `set trap` æ‹¦æˆªåˆ°ï¼Œåœ¨è¿™ä¸ª`trap` ä¸­ï¼Œä¸€å®šä¼šæ¥æ”¶åˆ°ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯åˆšæ‰æˆ‘ä»¬ä¸º `b1` åˆ›å»ºçš„ä¸­é—´å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ˜¯è¦è®¾ç½®çš„`key`å³`c1`ï¼Œç¬¬ä¸‰ä¸ªæ˜¯è¦è®¾ç½®çš„æ–°å€¼`'c1-edit'`ã€‚

**ä¸­é—´å¯¹è±¡**ä¸­ï¼Œæœ‰ä¸€ä¸ªæ ‡è¯†`modified_`ä¸€ç›´æ²¡ç”¨è¿‡ï¼Œå…¶å®è¿™ä¸ªæ ‡è¯†æ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰è¿™ä¸ªèŠ‚ç‚¹æ˜¯å¦è¢«è®¾ç½®è¿‡æ–°çš„å€¼ï¼Œå…ˆè®°ä½å®ƒï¼Œæœ€åå¤„ç†çš„æ—¶å€™è¦ä½¿ç”¨ã€‚é‚£ä¹ˆï¼Œ`set trap`çš„æ‰§è¡Œæµç¨‹å›¾å¦‚ä¸‹

![image-20211209170204558](./image/image-20211209170204558.png)

é‚£ä¹ˆ `b1.c1 = 'c1-edit'` è¿™ä¸€è¯­å¥çš„æ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹

![image-20211209170258825](./image/image-20211209170258825.png)



### 3.1.4	ç”Ÿæˆæ–°å¯¹è±¡

okï¼`recipe`å·²ç»æ‰§è¡Œå®Œæˆï¼æˆ‘ä»¬å¾—åˆ°äº†ä¸‹é¢å³è¾¹é‚£ä¸ªæ•°æ®ç»“æ„

![image-20211209164603159](./image/image-20211209164603159.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦ä»`baseState`çš„ä¸­é—´å¯¹è±¡å¼€å§‹å¾€ä¸‹éå†ï¼Œæ‰§è¡Œä¸€å®šçš„é€»è¾‘ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªå¤ç”¨æ— ä¿®æ”¹èŠ‚ç‚¹çš„æ–°çš„å¯¹è±¡ï¼Œæµç¨‹å¦‚ä¸‹

![image-20211209171917385](./image/image-20211209171917385.png)

åˆ°æ­¤ï¼Œæœ€åŸºæœ¬çš„`immerJs`çš„åŸç†å°±è¯´å®Œäº†



## 3.2	æ•°ç»„

æ•°ç»„å…¶å®å’Œå¯¹è±¡æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¹ˆä¸€ä¸ªæ•°ç»„

```ts
const arr = [
    { id: 1 },
    { id: 2 },
    { id: 3 },
    { id: 4 }
]
```

å…¶å®å¯ä»¥çœ‹æˆä¸€ä¸ªå¯¹è±¡

```ts
const arr = {
    0: { id: 1 },
    1: { id: 2 },
    2: { id: 3 },
    3: { id: 4 },
}
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`proxy traps`çš„é€»è¾‘ä¸éœ€è¦åŠ¨ï¼Œåªéœ€è¦åœ¨ç”Ÿæˆä¸­é—´å¯¹è±¡çš„æ—¶å€™ï¼Œæ ‡è¯†ä¸€ä¸‹éœ€è¦ç”Ÿæˆä¸­é—´å¯¹è±¡çš„å…ƒç´ æ˜¯æ•°ç»„è¿˜æ˜¯æ™®é€šå¯¹è±¡

![image-20211209173017798](./image/image-20211209173017798.png)



ç„¶åï¼Œåœ¨ç”Ÿæˆæ–°å¯¹è±¡çš„æ—¶å€™ï¼Œåˆ¤æ–­å½“å‰çš„ä¸­é—´å¯¹è±¡æ˜¯æ•°ç»„è¿˜æ˜¯æ™®é€šå¯¹è±¡ï¼Œç„¶åä½¿ç”¨ä¸åŒçš„æ–¹å¼éå†å’Œèµ‹å€¼

![image-20211209173152392](./image/image-20211209173152392.png)



# 4	immer

ç»ˆäºè®²å®ŒåŸç†äº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ‰‹å†™`immer`ï¼Œå½“ç„¶è¿™é‡Œåªæ˜¯ç®€å•çš„å®ç°ï¼Œé¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹

```shell
â”œâ”€â”€ immer
â”‚Â Â  â”œâ”€â”€ index.js		 -- immer-mini å…¥å£
â”‚Â Â  â”œâ”€â”€ proxy.js		 -- åˆ›å»ºä¸­é—´å¯¹è±¡å’Œå­˜æ”¾ traps çš„åœ°æ–¹
â”‚Â Â  â”œâ”€â”€ finalize.js      -- æŠŠä¸­é—´å¯¹è±¡è½¬åŒ–æˆæ™®é€šå¯¹è±¡
â”‚Â Â  â”œâ”€â”€ constants.js	 -- å­˜æ”¾å¸¸é‡
â”‚Â Â  â””â”€â”€ utils.js		 -- å­˜æ”¾å·¥å…·æ–¹æ³•
â””â”€â”€ index.js
```

æœ¬äººå»ºè®®ç›´æ¥è·³åˆ°ç¬¬äº”ç« ï¼Œç›´æ¥æŠŠä»£ç æ‹‰ä¸‹æ¥çœ‹ï¼Œå¦‚æœæŸä¸ªå‡½æ•°çœ‹ä¸æ‡‚ï¼Œå†çœ‹ä¸‹é¢çš„å†…å®¹ï¼Œå› ä¸ºä¸‹é¢å¤ªåºŸè¯äº†ï¼Œè¿˜ä¸å¦‚ç›´æ¥çœ‹å®ç°æ¥çš„å¿«

## 4.1	constants.js

> è¿™æ˜¯å­˜æ”¾å¸¸é‡çš„æ–‡ä»¶ï¼Œè¿™é‡Œåªéœ€è¦å­˜æ”¾ä¸¤ä¸ªå¸¸é‡ï¼Œå¦‚ä¸‹

ä¸€ä¸ªå°±æ˜¯ä¸­é—´å¯¹è±¡ä¸­ï¼Œç”¨æ¥æ ‡è¯†å½“å‰ä»£ç†çš„å€¼æ˜¯æ•°ç»„è¿˜æ˜¯å¯¹è±¡

```ts
/** åˆ¤æ–­ä»£ç†çš„æ˜¯å¯¹è±¡è¿˜æ˜¯æ•°ç»„ */
export const ProxyType = {
  ProxyObject: 'ProxyObject',
  ProxyArray: 'ProxyArray'
}
```

è¿˜æœ‰ä¸€ä¸ªï¼Œå°±æ˜¯ä¸€ä¸ªå•çº¯çš„`Symbol`

```ts
/** æ–¹ä¾¿å–åˆ°ä»£ç†çš„å¯¹è±¡ */
export const DRAFT_STATE = Symbol.for('immer-state')
```

è¿™ä¸ª`Symbol`æ˜¯è¿™ä¹ˆç”¨çš„ï¼Œ`immerJs`çš„æ ¸å¿ƒå°±æ˜¯ä¸­é—´å¯¹è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬å…¶å®åœ¨å¤–éƒ¨æ˜¯æ— æ³•ç›´æ¥è®¿é—®è¿™ä¸ªä¸­é—´å¯¹è±¡çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ç®¡æ€ä¹ˆè®¿é—®ï¼Œå°±ä¼šç»è¿‡ `get traps`ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦çº¦å®šä¸€ä¸‹ï¼Œå®šä¹‰ä¸€ä¸ª `Symbol key` ï¼Œå½“å–è¿™ä¸ª`proxy`å¯¹è±¡çš„`DRAFT_STATE`çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯å–è¿™ä¸ªä¸­é—´å¯¹è±¡

![image-20211209175513070](./image/image-20211209175513070.png)

## 4.2	utils.js

> ç”¨æ¥å®šä¹‰7ä¸ªæœ€åŸºæœ¬çš„å‡½æ•°ï¼Œå¦‚æœè®¤çœŸçœ‹è¿‡ä¸Šé¢çš„åŸç†è§£æçš„è¯ï¼Œé‚£ä¹ˆè¿™å‡ ä¸ªå‡½æ•°å°±ä¼šçŸ¥é“æ˜¯å¹²å˜›ç”¨çš„äº†

### 4.2.1	isDraftable

è¿™ä¸ªå‡½æ•°åœ¨æºç é‡Œé¢å…¶å®ä¸æ˜¯è¿™ä¹ˆå†™çš„ï¼Œä½†æ˜¯å› ä¸ºè¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆï¼Œæ‰€ä»¥åšäº†ä¸€äº›ä¿®æ”¹ã€‚`isDraftable`å°±å¹²äº†ä¸€ä»¶äº‹æƒ…ï¼Œåˆ¤æ–­ä¼ å…¥çš„`value`æ˜¯å¦å¯ä»¥åˆ›å»ºä¸­é—´å¯¹è±¡å—ï¼Ÿè¿™é‡Œåªæœ‰ä¼ å…¥`Object`ï¼Œ`Array`æ‰ä¼šè¿”å›`true`

![image-20211210095601295](./image/image-20211210095601295.png)

### 4.2.2	latest

è¿™å‡ ä¹æ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªå‡½æ•°äº†ï¼Œç”¨æ¥è·å–ä¸­é—´å¯¹è±¡ä¸­çš„ `copy_` æˆ– `base_`

![image-20211210095545066](./image/image-20211210095545066.png)

### 4.2.3	has

åˆ¤æ–­æŸä¸€ä¸ªå¯¹è±¡ä¸Šæ˜¯å¦å­˜åœ¨è¿™ä¸ªå±æ€§

![image-20211210095531272](./image/image-20211210095531272.png)

æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªè¿™ä¸ªä¾‹å­ï¼Œåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡ä¸Šæ˜¯å¦å­˜åœ¨è¿™ä¸ªå±æ€§éœ€è¦ä½¿ç”¨`hasOwnProperty`ï¼Œå¦‚æœç›´æ¥åˆ¤æ–­æ˜¯å¦ç­‰äº`undefined`ï¼Œä¼šå­˜åœ¨é—®é¢˜

```ts
const obj = { name: 1, address: '' }
obj.__proto__ = { age: 2 }

console.log(obj.hasOwnProperty('name'))     // true
console.log(obj.hasOwnProperty('age'))      // false
console.log(obj.hasOwnProperty('address'))  // true

console.log('---')

console.log(obj.name !== undefined)     // true
console.log(obj.age !== undefined)      // true
console.log(obj.address !== undefined)  // true
```

### 4.2.4	peek

æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå‡½æ•°å­—é¢æ„æ€

![image-20211210095510313](./image/image-20211210095510313.png)

### 4.2.5	markChanged

æŠŠå½“å‰ä¸­é—´å¯¹è±¡çš„ `modified_` å’Œçˆ¶èŠ‚ç‚¹çš„ `modified_` å…¨éƒ¨æ”¹æˆ`true`

![image-20211210095456988](./image/image-20211210095456988.png)

### 4.2.6	prepareCopy

æµ…æ‹·è´`base_`åˆ°ä¸­é—´å¯¹è±¡çš„`copy_`ä¸Š

![image-20211210095437642](./image/image-20211210095437642.png)

### 4.2.7	is

åˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸åŒï¼Œåœ¨ `set trap`çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸‹é¢çš„`is`å…¶å®å°±æ˜¯ `Object.is`çš„`Polyfill`ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆå†™ï¼Œå› ä¸º`immerJs`ä¸­éœ€è¦æ·»åŠ å¯¹`es5`çš„æ”¯æŒ

![image-20211210095425157](./image/image-20211210095425157.png)



## 4.3	proxy.js

å…·ä½“ä»£ç è§[github](https://github.com/bpuns/immer-study/blob/master/immer-mini/src/immer/proxy.js)ï¼Œæ³¨é‡Šå†™çš„éå¸¸è¯¦ç»†ï¼Œæœ‰ä¸¤éƒ¨åˆ†ç»„æˆ

![image-20211210095936108](./image/image-20211210095936108.png)



## 4.4	finalize.js

å¤„ç†`recipe`ç»“æŸä¹‹åçš„æ ¹ä¸­é—´å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„å¯¹è±¡

![image-20211210100047599](./image/image-20211210100047599.png)



## 4.5	index.js

æ¥ä¸‹æ¥å°±æ˜¯å…¥å£ä¸æ–‡ä»¶ï¼Œåˆ¤æ–­ä¼ å…¥çš„`base`æ˜¯å¦å¯ä»¥åˆ›å»ºä¸­é—´å¯¹è±¡ï¼Œå¦‚æœå¯ä»¥ï¼Œæ‰æ‰§è¡Œä¸Šé¢çš„æ‰€æœ‰é€»è¾‘ï¼Œè¦ä¹ˆå°±ç›´æ¥è¿”å›

![image-20211210100157979](./image/image-20211210100157979.png)

# 5	ç»“å°¾

ä¸Šæ–¹çš„æºç ï¼Œæˆ‘å·²ç»æ”¾åˆ°`git`ä»“åº“äº†ï¼Œåœ°å€ï¼š https://github.com/bpuns/immer-study

å…¶ä¸­æœ‰ä¸‰ä¸ªæ–‡ä»¶å¤¹

**immer-sourceï¼š** `immerJs`çš„æºç 

- å°±æ˜¯å®˜æ–¹æºç 

**immer-simpleï¼š** `immerJs`çš„ç®€å•å®ç°

- å®˜æ–¹æºç ç®€åŒ–ç‰ˆæœ¬ï¼Œæ²¡æœ‰å¤„ç†è¾¹ç¼˜æƒ…å†µï¼Œæ‰€ä»¥å¯èƒ½ä¼šå­˜åœ¨`bug`
- ä¸æ”¯æŒ `Map`ï¼Œ`Set`ä»£ç†
- ä¸æ”¯æŒè·Ÿè¸ªå˜åŒ–
- `produce`ä¸æ”¯æŒç¬¬ä¸‰ä¸ªå‚æ•°

**immer-miniï¼š** `immerJs`çš„`mini`çš„`mini`ç‰ˆæœ¬

- æ ¸å¿ƒåŸç†å®ç°ï¼Œä¸ä¼šå¤„ç†è¾¹ç¼˜æƒ…å†µï¼Œæ‰€ä»¥å¯èƒ½ä¼šå­˜åœ¨`bug`
- åªæ”¯æŒå¯¹è±¡å’Œæ•°ç»„çš„ä»£ç†ï¼Œåªæ”¯æŒä¿®æ”¹ï¼Œå¢åŠ ï¼Œåˆ é™¤æœ€ç®€å•å®ç°

